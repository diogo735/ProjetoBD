<div class="container py-4">

    <!-- Tabs para Lista de Matrículas -->
    <ul class="nav nav-tabs" id="matriculaTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="matricula-lista-tab" data-bs-toggle="tab"
                data-bs-target="#matricula-lista" type="button" role="tab" aria-controls="matricula-lista"
                aria-selected="true">
                Lista de Matrículas
            </button>
        </li>
    </ul>

    <div class="tab-content mt-4" id="matriculaTabContent">
        <!-- Tab Lista de Matrículas -->
        <div class="tab-pane fade show active" id="matricula-lista" role="tabpanel"
            aria-labelledby="matricula-lista-tab">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Matrículas dos Alunos</h2>
                </div>
                <div class="card-body">
                    <p>Listagem de todas as matrículas registradas na Universidade.</p>

                    <!-- Tabela de Matrículas -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID Matrícula</th>
                                    <th>Nome do Aluno</th>
                                    <th>Curso</th>
                                    <th>Ano Letivo</th>
                                    <th>Data da Matrícula</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if todas_matriculas %}
                                {% for matricula in todas_matriculas %}
                                <tr>
                                    <td>{{ matricula.id_matricula }}</td>
                                    <td>{{ matricula.nome_aluno }}</td>
                                    <td>{{ matricula.nome_curso }}</td>
                                    <td>{{ matricula.ano_letivo }}</td>
                                    <td>{{ matricula.data_matricula }}</td>
                                    <td>
                                        <!-- Botão Ver Detalhes -->
                                        <button type="button" class="btn btn-sm btn-primary"
                                            onclick="carregarDetalhes('{{ matricula.id_matricula }}')"
                                            data-bs-toggle="modal" data-bs-target="#detalhesModal">
                                            Ver Detalhes
                                        </button>

                                        <button type="button" class="btn btn-sm btn-warning"
                                            onclick="carregarDadosAtualizar('{{ matricula.id_matricula }}')"
                                            data-bs-toggle="modal" data-bs-target="#atualizarModal">
                                            Atualizar
                                        </button>

                                        <!-- Botão Remover -->
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                            data-bs-target="#removerModal-{{ matricula.id_matricula }}">
                                            Remover
                                        </button>

                                        <!-- Modal Remover -->
                                        <div class="modal fade" id="removerModal-{{ matricula.id_matricula }}"
                                            tabindex="-1"
                                            aria-labelledby="removerModalLabel-{{ matricula.id_matricula }}"
                                            aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title"
                                                            id="removerModalLabel-{{ matricula.id_matricula }}">
                                                            Confirmar Remoção</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Tem certeza que deseja remover a matrícula de <strong>{{
                                                                matricula.nome_aluno }}</strong>?</p>
                                                    </div>
                                                    <div class="modal-footer d-flex justify-content-end gap-2">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Cancelar</button>
                                                        <form method="POST"
                                                            action="{% url 'funcionario_delete_matricula' matricula.id_matricula %}">
                                                            {% csrf_token %}
                                                            <button type="submit"
                                                                class="btn btn-danger">Remover</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="modal fade" id="atualizarModal" tabindex="-1"
                                            aria-labelledby="atualizarModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="atualizarModalLabel">Atualizar
                                                            Matrícula</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form id="formAtualizarMatricula" method="POST">
                                                            {% csrf_token %}
                                                            <input type="hidden" id="idMatricula" name="id_matricula">

                                                            <div class="mb-3">
                                                                <label for="curso" class="form-label">Curso</label>
                                                                <input type="text" class="form-control" id="curso"
                                                                    name="curso" readonly>
                                                            </div>

                                                            <div class="mb-3">
                                                                <label for="ano_letivo" class="form-label">Ano
                                                                    Letivo</label>
                                                                <input type="text" class="form-control" id="ano_letivo"
                                                                    name="ano_letivo" readonly>
                                                            </div>

                                                            <div class="mb-3">
                                                                <label for="data_matricula" class="form-label">Data da
                                                                    Matrícula</label>
                                                                <input type="date" class="form-control"
                                                                    id="data_matricula" name="data_matricula">
                                                            </div>

                                                            <h5 class="mt-3">Unidades Curriculares</h5>
                                                            <div class="table-responsive">
                                                                <table class="table table-striped">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Selecionar</th>
                                                                            <th>Unidade Curricular</th>
                                                                            <th>Semestre</th>
                                                                            <th>Turno</th>

                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="tabelaUCs">
                                                                        <!-- Unidades Curriculares serão carregadas dinamicamente aqui -->
                                                                    </tbody>
                                                                </table>
                                                            </div>

                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                    data-bs-dismiss="modal">Cancelar</button>
                                                                <button type="submit" class="btn btn-success">Atualizar
                                                                    Matrícula</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>



                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">Nenhuma matrícula encontrada.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes da Matrícula -->
<div class="modal fade" id="detalhesModal" tabindex="-1" aria-labelledby="detalhesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detalhesModalLabel">Detalhes da Matrícula</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Curso:</strong> <span id="detalhesCurso"></span></p>
                <p><strong>Ano Letivo:</strong> <span id="detalhesAno"></span></p>
                <p><strong>Data da Matrícula:</strong> <span id="detalhesData"></span></p>

                <h5 class="mt-3">Unidades Curriculares</h5>
                <div id="tabelaUCs">
                    <!-- UCs serão agrupadas por semestre e carregadas dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function carregarDadosAtualizar(idMatricula) {
            fetch(`/funcionario/matricula/update_detalhes/${idMatricula}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("idMatricula").value = data.id_matricula;
                    document.getElementById("curso").value = data.nome_curso;
                    document.getElementById("ano_letivo").value = data.ano_letivo;
                    document.getElementById("data_matricula").value = data.data_matricula;

                    let tabelaUCs = document.getElementById("tabelaUCs");
                    tabelaUCs.innerHTML = "";

                    // Buscar todas as UCs disponíveis para o curso e ano letivo
                    fetch(`/funcionario/ucs/${data.curso_id}/${data.id_ano}/`)
                        .then(response => response.json())
                        .then(ucsData => {
                            console.log("Lista de UCs disponíveis:", ucsData);
                            console.log("Lista de UCs matriculadas:", data.ucs);

                            ucsData.forEach(uc => {
                                let ucInscrita = data.ucs.find(matriculada => Number(matriculada.id_uc) === Number(uc.id_uc));
                                let isChecked = ucInscrita !== undefined;
                                let turnoSelecionado = ucInscrita ? ucInscrita.id_turno : '';

                                let row = document.createElement("tr");
                                row.innerHTML = `
                                <td><input type="checkbox" name="ucs" value="${uc.id_uc}" ${isChecked ? 'checked' : ''}></td>
                                <td>${uc.nome}</td>
                                <td><span class="badge bg-secondary">S${uc.id_semestre}</span></td>
                                <td>
                                    <select name="turno_${uc.id_uc}" class="form-select turno-select" data-uc="${uc.id_uc}">
                                        <option value="">Carregando...</option>
                                    </select>
                                </td>
                            `;
                                tabelaUCs.appendChild(row);

                                // Buscar os turnos disponíveis para esta UC
                                fetch(`/funcionario/turnos/${uc.id_uc}/`)
                                    .then(response => response.json())
                                    .then(turnosData => {
                                        let select = tabelaUCs.querySelector(`select[name="turno_${uc.id_uc}"]`);
                                        select.innerHTML = "";
                                        turnosData.forEach(turno => {
                                            let option = document.createElement("option");
                                            option.value = turno.id_turno;
                                            option.textContent = `${turno.turno_nome} (Vagas: ${turno.vagas_totais})`;
                                            if (parseInt(turno.id_turno) === parseInt(turnoSelecionado)) {
                                                option.selected = true;
                                            }
                                            select.appendChild(option);
                                        });
                                    })
                                    .catch(error => console.error(`Erro ao carregar turnos para UC ${uc.id_uc}:`, error));
                            });
                        })
                        .catch(error => console.error("Erro ao carregar as UCs:", error));
                })
                .catch(error => console.error("Erro ao carregar os detalhes da matrícula:", error));
        }

        function carregarDetalhes(idMatricula) {
            fetch(`/funcionario/matricula/detalhes/${idMatricula}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("detalhesCurso").textContent = data.nome_curso;
                    document.getElementById("detalhesAno").textContent = data.ano_letivo;
                    document.getElementById("detalhesData").textContent = data.data_matricula;
                    let ucList = document.getElementById("detalhesUCs");
                    ucList.innerHTML = "";
                    data.ucs.forEach(uc => {
                        let li = document.createElement("li");
                        li.className = "list-group-item";
                        li.innerHTML = `<strong>${uc.unidade_curricular}</strong> - Turno: ${uc.turno}`;
                        ucList.appendChild(li);
                    });
                })
                .catch(error => console.error("Erro ao carregar os detalhes da matrícula:", error));
        }

    </script>