{% load static %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<div class="container py-4">

    <!-- Tabs para Detalhes e Turno -->
    <ul class="nav nav-tabs" id="horariosTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="detalhes-tab" data-bs-toggle="tab" data-bs-target="#detalhes"
                type="button" role="tab" aria-controls="detalhes" aria-selected="true">
                Detalhes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="turno-tab" data-bs-toggle="tab" data-bs-target="#turno" type="button"
                role="tab" aria-controls="turno" aria-selected="false">
                Turnos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="horarios-tab" data-bs-toggle="tab" data-bs-target="#horario" type="button"
                role="tab" aria-controls="horario" aria-selected="false">
                Hor√°rios
            </button>
        </li>
    </ul>

    <div class="tab-content mt-4" id="horariosTabContent">
        <!-- Tab Detalhes -->
        <div class="tab-pane fade show active" id="detalhes" role="tabpanel" aria-labelledby="detalhes-tab">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Turnos do Ano Letivo Atual - 2024/2025</h2>
                </div>
                <div class="card-body">
                    <p>Consulte os hor√°rios dos turnos por curso, ano e semestre para o ano letivo atual.</p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Curso</th>
                                    <th>Turno</th>
                                    <th>Ano</th>
                                    <th>Semestre</th>
                                    <th>Vagas Dispon√≠veis</th>
                                    <th>Hor√°rio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for turno in turnos %}
                                <tr>
                                    <td>{{ turno.curso }}</td>
                                    <td>{{ turno.nome_turno }}</td>
                                    <td>{{ turno.ano }}</td>
                                    <td>{{ turno.semestre }}</td>
                                    <td>{{ turno.vagas_totais }}</td>
                                    <td>
                                        <button type="button" class="btn btn-primary btn-sm"
                                            data-turno-nome="{{ turno.nome_turno }}"
                                            data-semestre="{{ turno.semestre }}" data-ano="{{ turno.ano }}"
                                            data-curso="{{ turno.curso }}" data-bs-toggle="modal"
                                            data-bs-target="#horarioModal" onclick="carregarHorariosComData(this)">
                                            Ver Hor√°rio
                                        </button>


                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6">Nenhum turno dispon√≠vel no momento.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Turno -->
        <div class="tab-pane fade" id="turno" role="tabpanel" aria-labelledby="turno-tab">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Configura√ß√µes de Turnos</h2>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#criarTurnoModal">
                        <i class="bi bi-plus"></i> Criar Turno
                    </button>
                </div>
                <div class="card-body">
                    <p>Pesquise por curso,ano e semestre para realizar ou alterar turnos.</p>
                    <form class="row g-3">
                        <div class="col-md-6">
                            <label for="cursoPesquisa" class="form-label">Curso</label>
                            <select id="cursoPesquisa" class="form-select" required>
                                <option selected disabled>Escolha o curso...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="anoPesquisa" class="form-label">Ano</label>
                            <select id="anoPesquisa" class="form-select" required>
                                <option selected disabled>Escolha o ano...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="semestrePesquisa" class="form-label">Semestre</label>
                            <select id="semestrePesquisa" class="form-select" required>
                                <option selected disabled>Escolha o semestre...</option>
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="button" class="btn btn-outline-primary" onclick="pesquisarDados()">
                                <i class="bi bi-search"></i> Pesquisar Turno
                            </button>
                        </div>
                    </form>


                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h6 mb-0">Resultados Dispon√≠veis: <span id="quantidadeResultados"></span></h3>
                        </div>
                        <div style="height: 23vh; overflow-y: auto;">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Turno</th>
                                        <th>Nome UC</th>
                                        <th>Vagas Restantes</th>
                                        <th>Vagas Totais</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <div id="loadingSpinner" class="text-center my-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </div>
                                <tbody id="resultadosDisponiveis">
                                    <!-- Resultados dos turnos ir√£o aparecer aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Tab Hor√°rios -->
        <div class="tab-pane fade" id="horario" role="tabpanel" aria-labelledby="horarios-tab">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Gerenciamento de Hor√°rios</h2>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#criarHorarioModal" onclick="carregarTurnosSemHorarios()">
                        <i class="bi bi-plus"></i> Adicionar Hor√°rio
                    </button>
                </div>
                <div class="card-body">
                    <p>Pesquisar hor√°rios dos turnos</p>
                    <form class="row g-3">
                        <div class="col-md-6">
                            <label for="cursoPesquisa_horarios" class="form-label">Curso</label>
                            <select id="cursoPesquisa_horarios" class="form-select" required>
                                <option selected disabled>Escolha o curso...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ano_horario" class="form-label">Ano</label>
                            <select id="ano_horario" class="form-select" required>
                                <option selected disabled>Escolha o ano...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="semestre_horario" class="form-label">Semestre</label>
                            <select id="semestre_horario" class="form-select" required>
                                <option selected disabled>Escolha o semestre...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="turno_horario" class="form-label">Turno</label>
                            <select id="turno_horario" class="form-select" required>
                                <option selected disabled>Escolha o turno...</option>
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="button" class="btn btn-outline-primary" onclick="pesquisarHorarios()">
                                <i class="bi bi-search"></i> Pesquisar Hor√°rio
                            </button>
                        </div>
                    </form>

                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h6 mb-0">Resultados Dispon√≠veis: <span id="quantidadeResultados_horarios"></span>
                            </h3>
                        </div>
                        <div style="height: 23vh; overflow-y: auto;">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Turno</th>
                                        <th>Unidade Curricular</th>
                                        <th>Dia da Semana</th>
                                        <th>Hora In√≠cio</th>
                                        <th>Hora Fim</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <div id="loadingSpinner" class="text-center my-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </div>
                                <tbody id="resultadosDisponiveis_horarios">
                                    <!-- Resultados dos hor√°rios ir√£o aparecer aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Modal para Ver Hor√°rio -->
        <div class="modal fade" id="horarioModal" tabindex="-1" aria-labelledby="horarioModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" style="max-width: 80%; margin: 5vh auto;">
                <div class="modal-content" style="max-height: 90vh; overflow: hidden;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="horarioModalLabel">Hor√°rios do Turno</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="max-height: calc(90vh - 60px); overflow-y: auto;">
                        <table class="table table-bordered" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Segunda-feira</th>
                                    <th>Ter√ßa-feira</th>
                                    <th>Quarta-feira</th>
                                    <th>Quinta-feira</th>
                                    <th>Sexta-feira</th>
                                </tr>
                            </thead>
                            <tbody id="horariosTableBody">
                                <!-- Os hor√°rios ser√£o gerados dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal para Criar Turno -->
        <div class="modal fade" id="criarTurnoModal" tabindex="-1" aria-labelledby="criarTurnoModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="criarTurnoModalLabel">Criar Novo Turno</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formCriarTurno" onsubmit="event.preventDefault(); enviarFormularioCriarTurno();">
                            <div class="mb-3">
                                <label for="nomeTurno" class="form-label">Nome do Turno</label>
                                <div class="input-group">
                                    <select class="form-select" id="selectNomeTurno">
                                        <option selected disabled>Escolha um turno existente...</option>
                                    </select>
                                    <input type="text" class="form-control" id="inputNomeTurno"
                                        placeholder="Ou digite um novo nome">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="vagasTurno" class="form-label">N√∫mero de Vagas</label>
                                <input type="number" class="form-control" id="vagasTurno"
                                    placeholder="Digite o n√∫mero de vagas" required>
                            </div>
                            <div class="mb-3">
                                <label for="cursoTurno" class="form-label">Curso</label>
                                <select class="form-select" id="cursoTurno" required>
                                    <option selected disabled>Escolha o curso...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="anoTurno" class="form-label">Ano</label>
                                <select class="form-select" id="anoTurno" required>
                                    <option selected disabled>Escolha o ano...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="semestreTurno" class="form-label">Semestre</label>
                                <select class="form-select" id="semestreTurno" required>
                                    <option selected disabled>Escolha o semestre...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="ucTurno" class="form-label">Unidade Curricular (UC)</label>
                                <select class="form-select" id="ucTurno" required>
                                    <option selected disabled>Selecione Curso, Ano e Semestre</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary"><i
                                        class="bi bi-save me-2"></i>Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>





        <!-- Modal Editar Turno -->
        <div class="modal fade" id="editarTurnoModal" tabindex="-1" aria-labelledby="editarTurnoLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editarTurnoLabel">Editar Turno</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formEditarTurno">
                            <!-- ID do Turno (oculto) -->
                            <input type="hidden" id="editTurnoId">

                            <!-- Nome do Turno -->
                            <div class="mb-3">
                                <label for="editarNomeTurno" class="form-label">Nome do Turno</label>
                                <input type="text" class="form-control" id="editarNomeTurno" required>
                            </div>

                            <!-- N√∫mero de Vagas Totais -->
                            <div class="mb-3">
                                <label for="editarVagasTotais" class="form-label">N√∫mero de Vagas Totais</label>
                                <input type="number" class="form-control" id="editarVagasTotais"
                                    placeholder="Digite o n√∫mero de vagas totais" required>
                            </div>

                            <!-- N√∫mero de Vagas Ocupadas -->
                            <div class="mb-3">
                                <p id="vagasOcupadasTexto">N√∫mero de Vagas Ocupadas: <strong
                                        id="editarVagasOcupadas">--</strong></p>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="btnGuardarTurno"
                            onclick="enviarFormularioEditarTurno()" disabled>
                            <i class="bi bi-save me-2"></i>Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>




        <!-- Modal para Gerenciar Alunos do Turno -->
        <div class="modal fade" id="editarVagasModal" tabindex="-1" aria-labelledby="editarVagasModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editarVagasModalLabel">Alunos Inscritos no Turno</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-striped">
                            <thead>
                                <input type="hidden" id="editTurnoId">
                                <tr>
                                    <th scope="col">
                                        <input type="checkbox" id="selecionarTodos"
                                            onchange="selecionarTodosAlunos(this)">
                                    </th>
                                    <th scope="col">N¬∫ Mec</th>
                                    <th scope="col">Nome Completo</th>
                                </tr>
                            </thead>
                            <tbody id="listaAlunosTurno">
                                <!-- Alunos ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <!-- Bot√£o Adicionar Aluno -->
                        <button type="button" class="btn btn-warning text-dark" onclick="adicionarAluno()">
                            <i class="fas fa-user-plus"></i> Adicionar Aluno
                        </button>
                        <!-- Bot√£o Remover Selecionados -->
                        <button type="button" class="btn btn-danger" id="btnRemoverAlunos"
                            onclick="removerAlunosSelecionados()" disabled>
                            <i class="fas fa-user-minus"></i> Remover Selecionados
                        </button>
                    </div>

                </div>
            </div>
        </div>


        <!-- Modal para Eliminar Turno -->
        <div class="modal fade" id="eliminarTurnoModal" tabindex="-1" aria-labelledby="eliminarTurnoModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eliminarTurnoModalLabel">Confirmar Exclus√£o
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza de que deseja excluir o turno <strong id="turnoNomeExcluir"></strong>?</p>
                        <div id="detalhesTurno">
                            <!-- Detalhes din√¢micos ser√£o inseridos aqui -->
                        </div>
                    </div>
                    <div class="modal-footer">

                        <button type="button" class="btn btn-danger" onclick="confirmarExclusaoTurno()"><i
                                class="bi bi-trash me-2"></i>Excluir</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para criar horario-->
        <div class="modal fade" id="criarHorarioModal" tabindex="-1" aria-labelledby="criarHorarioModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- Cabe√ßalho do Modal -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="criarHorarioModalLabel">Adicionar Hor√°rio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <!-- Corpo do Modal -->
                    <div class="modal-body">
                        <!-- Div para exibir mensagens de sucesso ou erro -->
                        <div id="mensagemAlerta" class="alert d-none" role="alert"></div>
                        <form id="formAdicionarHorario">
                            <div class="mb-3">
                                <label for="idTurno" class="form-label">Associar Turno</label>
                                <select class="form-select" id="idTurno" required>
                                    <option value="" disabled selected>Selecione o turno...</option>
                                    <!-- Op√ß√µes preenchidas dinamicamente -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="diaSemana" class="form-label">Dia da Semana</label>
                                <select class="form-select" id="diaSemana" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="Segunda-feira">Segunda-feira</option>
                                    <option value="Ter√ßa-feira">Ter√ßa-feira</option>
                                    <option value="Quarta-feira">Quarta-feira</option>
                                    <option value="Quinta-feira">Quinta-feira</option>
                                    <option value="Sexta-feira">Sexta-feira</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="horaInicio" class="form-label">Hora de In√≠cio</label>
                                <input type="time" class="form-control" id="horaInicio" required>
                            </div>
                            <div class="mb-3">
                                <label for="horaFim" class="form-label">Hora de T√©rmino</label>
                                <input type="time" class="form-control" id="horaFim" required>
                            </div>
                            <div class="mb-3">
                                <label for="idEspaco" class="form-label">Espa√ßo</label>
                                <select class="form-select" id="idEspaco" required>
                                    <option value="" disabled selected>Selecione o espa√ßo...</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <!-- Rodap√© do Modal -->
                    <div class="modal-footer">

                        <button type="button" class="btn btn-primary" onclick="adicionarHorario()"><i
                                class="bi bi-save me-2"></i>Guardar</button>
                    </div>
                </div>
            </div>
        </div>





        <!-- Modal para Editar Hor√°rio -->
        <div class="modal fade" id="editarHorarioModal" tabindex="-1" aria-labelledby="editarHorarioModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title" id="editarHorarioModalLabel">Editar Hor√°rio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editarHorarioForm">
                            <div class="mb-3">
                                <label for="editarDiaSemana" class="form-label">Dia da Semana</label>
                                <select id="editarDiaSemana" class="form-select" required>
                                    <option value="" selected disabled>Escolha o dia...</option>
                                    <option value="Segunda-feira">Segunda-feira</option>
                                    <option value="Ter√ßa-feira">Ter√ßa-feira</option>
                                    <option value="Quarta-feira">Quarta-feira</option>
                                    <option value="Quinta-feira">Quinta-feira</option>
                                    <option value="Sexta-feira">Sexta-feira</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editarHoraInicio" class="form-label">Hora de In√≠cio</label>
                                <input type="time" id="editarHoraInicio" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="editarHoraFim" class="form-label">Hora de Fim</label>
                                <input type="time" id="editarHoraFim" class="form-control" required>
                            </div>
                            <input type="hidden" id="editarHorarioId">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" id="botaoSalvar" disabled
                            onclick="salvarEdicaoHorario()">Salvar</button>

                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Remover Hor√°rio -->
        <div class="modal fade" id="removerHorarioModal" tabindex="-1" aria-labelledby="removerHorarioModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="removerHorarioModalLabel">Confirma√ß√£o de Remo√ß√£o</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Tem a certeza que quer eliminar este hor√°rio?
                    </div>
                    <div class="modal-footer">

                        <button id="confirmarRemocaoBtn" type="button" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Apagar
                        </button>
                    </div>
                </div>
            </div>
        </div>




        <script>
            // üöÄ Fun√ß√£o gen√©rica para preencher selects
            function preencherSelect(selectElement, dados, defaultOption) {
                selectElement.innerHTML = `<option selected disabled>${defaultOption}</option>`;
                dados.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id || item.id_ano || item.id_semestre || item.id_curso;
                    option.textContent = item.nome || item.nome_ano || item.nome_semestre || item.nome_curso;
                    selectElement.appendChild(option);
                });
            }

            // ‚úÖ Fun√ß√£o para inicializar os campos do formul√°rio
            function inicializarFormulario() {
                carregarCursos();       // Preenche o seletor de cursos
                carregarAnos();         // Preenche o seletor de anos
                carregarSemestres();    // Preenche o seletor de semestres
            }

            // ‚úÖ Chamando a fun√ß√£o quando a p√°gina √© carregada
            document.addEventListener('DOMContentLoaded', () => {
                inicializarFormulario();
            });

            // ‚úÖ Fun√ß√£o para carregar Cursos na Pesquisa e Modal
            function carregarCursos() {
                fetch('/obter_cursos/')
                    .then(response => response.json())
                    .then(data => {
                        // Preenche o seletor de cursos na pesquisa
                        const selectCursoPesquisa = document.getElementById('cursoPesquisa');
                        preencherSelect(selectCursoPesquisa, data, 'Escolha o curso...');

                        // Preenche o seletor de cursos no modal
                        const selectCursoTurno = document.getElementById('cursoTurno');
                        preencherSelect(selectCursoTurno, data, 'Escolha o curso...');
                    })
                    .catch(error => console.error('Erro ao carregar cursos:', error));
            }

            // ‚úÖ Fun√ß√£o para carregar Anos
            function carregarAnos() {
                fetch('/obter_anos/')
                    .then(response => {
                        console.log('Status da resposta ao carregar anos:', response.status); // Loga o status
                        return response.json();
                    })
                    .then(data => {

                        console.log('Dados recebidos para anos:', data); // Loga os dados recebidos

                        const selectAnoPesquisa = document.getElementById('anoPesquisa');
                        preencherSelect(selectAnoPesquisa, data, 'Escolha o ano...');

                        const selectAno = document.getElementById('anoTurno');
                        preencherSelect(selectAno, data, 'Escolha o ano...');
                    })
                    .catch(error => console.error('Erro ao carregar anos:', error));
            }

            // ‚úÖ Fun√ß√£o para carregar Semestres
            function carregarSemestres() {
                fetch('/obter_semestres/')
                    .then(response => {
                        console.log('Status da resposta ao carregar semestres:', response.status); // Loga o status
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados recebidos para semestres:', data); // Loga os dados recebidos

                        const selectSemestrePesquisa = document.getElementById('semestrePesquisa');
                        preencherSelect(selectSemestrePesquisa, data, 'Escolha o ano...');

                        const selectSemestre = document.getElementById('semestreTurno');
                        preencherSelect(selectSemestre, data, 'Escolha o semestre...');
                    })
                    .catch(error => console.error('Erro ao carregar semestres:', error));
            }


            // ‚úÖ Inicializar fun√ß√µes ao carregar a p√°gina
            document.addEventListener('DOMContentLoaded', () => {
                carregarCursos();
                carregarAnos();
                carregarSemestres();
            });

            // üöÄ Fun√ß√£o para carregar nomes de turnos
            function carregarNomesTurnos() {
                fetch('/obter_nomes_turnos/')
                    .then(response => response.json())
                    .then(data => {
                        const selectNomeTurno = document.getElementById('selectNomeTurno');
                        selectNomeTurno.innerHTML = '<option selected disabled>Escolha um turno existente...</option>';
                        data.forEach(turno => {
                            const option = document.createElement('option');
                            option.value = turno;
                            option.textContent = turno;
                            selectNomeTurno.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro ao carregar nomes de turnos:', error));
            }

            // üöÄ Sincronizar Dropdown e Input de Turno
            document.getElementById('selectNomeTurno').addEventListener('change', function () {
                const inputNomeTurno = document.getElementById('inputNomeTurno');
                inputNomeTurno.value = this.value;
            });

            // üöÄ Chamar ao Carregar a P√°gina
            document.addEventListener('DOMContentLoaded', () => {
                carregarNomesTurnos();
            });
            function carregarUCs() {
                const curso = document.getElementById('cursoTurno').options[document.getElementById('cursoTurno').selectedIndex].text;
                const ano = document.getElementById('anoTurno').options[document.getElementById('anoTurno').selectedIndex].text;
                const semestre = document.getElementById('semestreTurno').options[document.getElementById('semestreTurno').selectedIndex].text;
                const selectUC = document.getElementById('ucTurno');

                if (!curso || !ano || !semestre || curso === 'Escolha o curso...' || ano === 'Escolha o ano...' || semestre === 'Escolha o semestre...') {
                    console.warn('Selecione Curso, Ano e Semestre antes de carregar as UCs.');
                    selectUC.innerHTML = '<option selected disabled>Selecione Curso, Ano e Semestre</option>';
                    return;
                }

                selectUC.innerHTML = '<option disabled selected>Carregando UCs...</option>';

                console.log(`Par√¢metros enviados: curso=${curso}, ano=${ano}, semestre=${semestre}`);

                fetch(`/obter_ucs/?curso=${encodeURIComponent(curso)}&ano=${encodeURIComponent(ano)}&semestre=${encodeURIComponent(semestre)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao carregar UCs');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados recebidos:', data);
                        selectUC.innerHTML = '<option selected disabled>Escolha uma UC...</option>';
                        if (data.length > 0) {
                            data.forEach(uc => {
                                const option = document.createElement('option');
                                option.value = uc.id_uc;
                                option.textContent = uc.nome_uc;
                                selectUC.appendChild(option);
                            });
                        } else {
                            selectUC.innerHTML = '<option selected disabled>Nenhuma UC encontrada</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar UCs:', error);
                        selectUC.innerHTML = '<option selected disabled>Erro ao carregar UCs</option>';
                    });
            }


            // Adiciona eventos para garantir que as UCs s√£o carregadas ap√≥s sele√ß√£o dos tr√™s campos
            ['cursoTurno', 'anoTurno', 'semestreTurno'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const curso = document.getElementById('cursoTurno').value;
                    const ano = document.getElementById('anoTurno').value;
                    const semestre = document.getElementById('semestreTurno').value;

                    if (curso && ano && semestre) {
                        carregarUCs();
                    }
                });
            });


            // Adiciona eventos nos selects para garantir a atualiza√ß√£o correta
            document.getElementById('cursoTurno').addEventListener('change', carregarUCs);
            document.getElementById('anoTurno').addEventListener('change', carregarUCs);
            document.getElementById('semestreTurno').addEventListener('change', carregarUCs);
            // Chama a fun√ß√£o ao carregar a p√°gina
            document.addEventListener('DOMContentLoaded', function () {
                carregarCursosPesquisa(); // Carrega cursos para pesquisa ao carregar a p√°gina
            });

            function pesquisarDados() {
                console.log('üîç Iniciando pesquisa de turnos...');

                // Obter os elementos dos selects
                const cursoElemento = document.getElementById('cursoPesquisa');
                const anoElemento = document.getElementById('anoPesquisa');
                const semestreElemento = document.getElementById('semestrePesquisa');

                // Verificar se os elementos foram encontrados
                console.log('üõ†Ô∏è Elementos encontrados:', {
                    cursoElemento,
                    anoElemento,
                    semestreElemento
                });

                if (!cursoElemento || !anoElemento || !semestreElemento) {
                    console.error('‚ùå Um ou mais elementos do formul√°rio n√£o foram encontrados.');
                    alert('Erro interno: N√£o foi poss√≠vel encontrar os campos do formul√°rio.');
                    return;
                }

                // Obter os valores selecionados
                const cursoSelecionado = cursoElemento.value;
                const anoSelecionado = anoElemento.value;
                const semestreSelecionado = semestreElemento.value;

                // Valida√ß√£o dos valores selecionados
                if (
                    cursoSelecionado === 'Escolha o curso...' ||
                    anoSelecionado === 'Escolha o ano...' ||
                    semestreSelecionado === 'Escolha o semestre...'
                ) {
                    alert('‚ö†Ô∏è Por favor, selecione um curso, ano e semestre v√°lidos.');
                    console.warn('‚ö†Ô∏è Um ou mais valores inv√°lidos foram selecionados.');
                    return;
                }

                console.log('üìä Valores selecionados:', {
                    curso: cursoSelecionado,
                    ano: anoSelecionado,
                    semestre: semestreSelecionado
                });

                // Enviar solicita√ß√£o para buscar dados com base nos par√¢metros
                fetch(`/buscar_dados/?curso=${cursoSelecionado}&ano=${anoSelecionado}&semestre=${semestreSelecionado}`)
                    .then(response => {
                        console.log('‚úÖ Resposta do servidor:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('üì• Dados recebidos:', data);
                        const tabelaResultados = document.getElementById('resultadosDisponiveis');
                        tabelaResultados.innerHTML = ''; // Limpa os resultados antigos

                        const quantidadeResultados = document.getElementById('quantidadeResultados');
                        quantidadeResultados.textContent = data.length; // Atualiza a quantidade de resultados

                        if (data.length > 0) {
                            document.getElementById('loadingSpinner').style.display = 'block';

                            data.forEach(item => {
                                const row = `
                    <tr>
                        <td>${item.turno_nome}</td>
                        <td>${item.nome_uc}</td>
                        <td>${item.vagas_restantes} Vagas</td>
                        <td>${item.vagas_totais} Vagas</td>
                        <td>
                            <button type="button" class="btn btn-warning btn-sm" onclick="editarTurno(${item.id_turno})">
                                <i class="bi bi-pencil"></i> Editar Turno
                            </button>
                            <button type="button" class="btn btn-info btn-sm" onclick="editarVagas(${item.id_turno})">
    <i class="fas fa-users"></i> Editar Vagas
</button>

                            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarTurno(${item.id_turno})">
                                <i class="bi bi-trash me-2"></i> Eliminar Turno
                            </button>
                        </td>
                    </tr>`;
                                tabelaResultados.innerHTML += row;
                            });

                            document.getElementById('loadingSpinner').style.display = 'none';
                        } else {
                            tabelaResultados.innerHTML = `
                <tr>
                    <td colspan="5">Nenhum dado dispon√≠vel para os crit√©rios selecionados.</td>
                </tr>`;
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao buscar dados:', error);
                        alert('Erro ao buscar dados. Verifique o console para mais informa√ß√µes.');
                    });
            }

            function carregarHorarios(turnoNome, semestre, ano, curso) {
                let tableBody = document.getElementById('horariosTableBody');
                tableBody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';

                let params = new URLSearchParams({
                    turno_nome: turnoNome,
                    semestre: semestre.replace(' ', ''),
                    ano: ano.replace(' ', ''),
                    curso: curso
                });

                console.log('Par√¢metros enviados:', params.toString());

                fetch(`/funcionario/obter_horarios/?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados recebidos:', data);
                        tableBody.innerHTML = ''; // Limpa a tabela

                        // Definir intervalo de hor√°rios em blocos de 30 minutos
                        let startTime = new Date('1970-01-01T08:00:00');
                        let endTime = new Date('1970-01-01T18:00:00');
                        let currentTime = new Date(startTime);

                        // Fun√ß√£o para formatar hora
                        function formatTime(date) {
                            return date.toTimeString().split(':').slice(0, 2).join(':');
                        }

                        // Preencher a tabela com blocos de 30 minutos
                        while (currentTime < endTime) {
                            let nextTime = new Date(currentTime);
                            nextTime.setMinutes(currentTime.getMinutes() + 30); // Avan√ßa 30 minutos

                            let row = `<tr><td>${formatTime(currentTime)} - ${formatTime(nextTime)}</td>`;

                            ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'].forEach(dia => {
                                let horarioOcupado = data.find(horario => {
                                    let horarioInicio = new Date(`1970-01-01T${horario.hora_inicio}`);
                                    let horarioFim = new Date(`1970-01-01T${horario.hora_fim}`);
                                    return horario.dia_semana === dia &&
                                        currentTime >= horarioInicio &&
                                        currentTime < horarioFim;
                                });

                                if (horarioOcupado) {
                                    let horarioInicio = new Date(`1970-01-01T${horarioOcupado.hora_inicio}`);
                                    let horarioFim = new Date(`1970-01-01T${horarioOcupado.hora_fim}`);
                                    let rowspan = (horarioFim - horarioInicio) / (30 * 60 * 1000); // N√∫mero de blocos de 30 min

                                    // Apenas insere se estiver no in√≠cio do intervalo
                                    if (currentTime.getTime() === horarioInicio.getTime()) {
                                        row += `<td rowspan="${rowspan}" style="background-color: #007bff; color: white; text-align: center; vertical-align: middle;">
                                ${horarioOcupado.nome_uc} <br> Sala: ${horarioOcupado.espaco}
                            </td>`;
                                    }
                                } else {
                                    row += `<td></td>`; // C√©lula vazia
                                }
                            });

                            row += `</tr>`;
                            tableBody.innerHTML += row;
                            currentTime = nextTime; // Avan√ßa para o pr√≥ximo intervalo
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar hor√°rios:', error);
                        tableBody.innerHTML = '<tr><td colspan="6">Erro ao carregar hor√°rios. Tente novamente mais tarde.</td></tr>';
                    });
            }


            // Bot√£o para carregar os hor√°rios
            function carregarHorariosComData(button) {
                const turnoNome = button.getAttribute('data-turno-nome');
                const semestre = button.getAttribute('data-semestre');
                const ano = button.getAttribute('data-ano');
                const curso = button.getAttribute('data-curso');

                carregarHorarios(turnoNome, semestre, ano, curso);
            }



            function enviarFormularioCriarTurno() {
                // Captura dos elementos do formul√°rio
                const selectNomeTurno = document.getElementById('selectNomeTurno');
                const inputNomeTurno = document.getElementById('inputNomeTurno');
                const vagasTurno = document.getElementById('vagasTurno');
                const cursoTurno = document.getElementById('cursoTurno');
                const anoTurno = document.getElementById('anoTurno');
                const semestreTurno = document.getElementById('semestreTurno');
                const ucTurno = document.getElementById('ucTurno');

                // Valida√ß√£o b√°sica dos campos
                if (!cursoTurno.value || !anoTurno.value || !semestreTurno.value || !ucTurno.value) {
                    alert('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios antes de salvar.');
                    return;
                }

                // Determinar qual nome do turno usar
                const nomeTurno = inputNomeTurno.value.trim() !== ''
                    ? inputNomeTurno.value
                    : selectNomeTurno.value;

                if (!nomeTurno) {
                    alert('‚ö†Ô∏è Por favor, selecione ou insira um nome para o turno.');
                    return;
                }

                // Constru√ß√£o do objeto com os dados para envio
                const formData = {
                    nome_turno: nomeTurno,
                    vagas_turno: parseInt(vagasTurno.value) || 0,
                    id_curso: parseInt(cursoTurno.value) || 0,
                    ano_turno: parseInt(anoTurno.value) || 0,
                    semestre_turno: parseInt(semestreTurno.value) || 0,
                    id_uc: parseInt(ucTurno.value) || 0
                };

                console.log('üì§ Dados enviados:', formData);

                // Envio dos dados para o backend
                fetch('/criar_turno/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const modalBody = document.querySelector('#criarTurnoModal .modal-body');
                        const modalContent = document.querySelector('#criarTurnoModal .modal-content');
                        const btnSalvar = document.querySelector('#criarTurnoModal .modal-footer .btn-primary');

                        if (data.success) {
                            // üü¢ Modal de Sucesso
                            modalBody.innerHTML = `
                    <div class="text-center">
                        <h4 class="text-success">‚úÖ Turno criado com sucesso!</h4>
                        
                    </div>
                `;
                            modalContent.style.backgroundColor = '#d4edda'; // Fundo verde
                            modalContent.style.color = '#155724'; // Texto verde escuro
                            if (btnSalvar) {
                                btnSalvar.style.display = 'none';
                            }
                            // Redefinir modal ap√≥s 2 segundos
                            setTimeout(() => {
                                resetarModal();
                            }, 2000);
                        } else {
                            // üî¥ Modal de Erro
                            modalBody.innerHTML = `
                    <div class="text-center">
                        <p>${data.error}</p>
                       
                    </div>
                `;
                            modalContent.style.backgroundColor = '#f8d7da'; // Fundo vermelho
                            modalContent.style.color = '#721c24'; // Texto vermelho escuro
                            if (btnSalvar) {
                                btnSalvar.style.display = 'none';
                            }
                        }

                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao criar turno:', error);
                        const modalBody = document.querySelector('#criarTurnoModal .modal-body');
                        const modalContent = document.querySelector('#criarTurnoModal .modal-content');
                        const btnSalvar = document.querySelector('#criarTurnoModal .modal-footer .btn-primary');

                        // üî¥ Modal de Erro Cr√≠tico
                        modalBody.innerHTML = `
                <div class="text-center">
                    <h4 class="text-danger">‚ùå Erro cr√≠tico ao criar turno</h4>
                    <p>${error.message}</p>
                   
                </div>
            `;
                        modalContent.style.backgroundColor = '#f8d7da'; // Fundo vermelho
                        modalContent.style.color = '#721c24'; // Texto vermelho escuro
                        if (btnSalvar) {
                            btnSalvar.style.display = 'none';
                        }


                    });
            }

            function resetarModal() {
                // Sele√ß√£o dos elementos do modal
                const formCriarTurno = document.getElementById('formCriarTurno');
                const modalBody = document.querySelector('#criarTurnoModal .modal-body');
                const modalContent = document.querySelector('#criarTurnoModal .modal-content');
                const btnSalvar = document.querySelector('#criarTurnoModal .modal-footer .btn-primary');

                // Redefinir o formul√°rio somente se ele existir
                if (formCriarTurno) {
                    formCriarTurno.reset();
                }

                // Restaurar selects para a op√ß√£o padr√£o
                const selectNomeTurno = document.getElementById('selectNomeTurno');
                const cursoTurno = document.getElementById('cursoTurno');
                const anoTurno = document.getElementById('anoTurno');
                const semestreTurno = document.getElementById('semestreTurno');
                const ucTurno = document.getElementById('ucTurno');

                if (selectNomeTurno) {
                    selectNomeTurno.innerHTML = `
            <option selected disabled>Escolha um turno existente...</option>
        `;
                }
                if (cursoTurno) {
                    cursoTurno.innerHTML = `
            <option selected disabled>Escolha o curso...</option>
        `;
                }
                if (anoTurno) {
                    anoTurno.innerHTML = `
            <option selected disabled>Escolha o ano...</option>
        `;
                }
                if (semestreTurno) {
                    semestreTurno.innerHTML = `
            <option selected disabled>Escolha o semestre...</option>
        `;
                }
                if (ucTurno) {
                    ucTurno.innerHTML = `
            <option selected disabled>Selecione Curso, Ano e Semestre</option>
        `;
                }

                // Restaurar estilos padr√£o
                if (modalContent) {
                    modalContent.style.backgroundColor = '';
                    modalContent.style.color = '';
                }

                // Restaurar bot√£o de salvar
                if (btnSalvar) {
                    btnSalvar.style.display = '';
                }
            }




            const botaoAbrirModal = document.querySelector('[data-bs-target="#criarTurnoModal"]');
            if (botaoAbrirModal) {
                botaoAbrirModal.addEventListener('click', () => {
                    resetarModal(); // Redefinir o modal para o estado inicial
                    carregarNomesTurnos(); // Recarregar os dados necess√°rios
                    carregarCursos();
                    carregarAnos();
                    carregarSemestres();
                    carregarUCs();
                    console.log('üì• Modal resetado e dados carregados.');
                });
            }


            // Fun√ß√£o para obter o CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>

        <script>
            let turnoOriginal = {};

            // Armazenar o conte√∫do original do modal
            const modalBodyOriginal = document.querySelector('#editarTurnoModal .modal-body').innerHTML;
            const modalFooterOriginal = document.querySelector('#editarTurnoModal .modal-footer').innerHTML;

            // ‚úÖ Fun√ß√£o para editar turno
            function editarTurno(idTurno) {
                console.log('Editando turno com ID:', idTurno);

                // Restaurar o conte√∫do original do modal antes de preencher
                document.querySelector('#editarTurnoModal .modal-content').style.backgroundColor = '#FFFFFF';
                document.querySelector('#editarTurnoModal .modal-body').innerHTML = modalBodyOriginal;
                document.querySelector('#editarTurnoModal .modal-footer').innerHTML = modalFooterOriginal;

                // Enviar solicita√ß√£o para obter os detalhes do turno
                fetch(`/obter_detalhes_turno/${idTurno}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao carregar detalhes do turno.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados recebidos:', data);

                        // Armazenar os valores originais
                        turnoOriginal = {
                            nome: data.turno_nome,
                            vagasTotais: data.vagas_totais,
                            vagasOcupadas: data.vagas_ocupadas
                        };

                        // Preencher o formul√°rio com os dados do turno
                        document.getElementById('editTurnoId').value = data.id_turno;
                        document.getElementById('editarNomeTurno').value = data.turno_nome || '';
                        document.getElementById('editarVagasTotais').value = data.vagas_totais || 0;

                        // Preencher o valor das vagas ocupadas
                        document.getElementById('editarVagasOcupadas').innerText = data.vagas_ocupadas || 0;

                        // Mostrar o modal
                        const editarModal = new bootstrap.Modal(document.getElementById('editarTurnoModal'));
                        monitorarMudancas();
                        validarVagasTotais();
                        editarModal.show();
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao obter detalhes do turno:', error);
                        alert('Erro ao carregar detalhes do turno.');
                    });
            }


            // ‚úÖ Fun√ß√£o para monitorar altera√ß√µes no formul√°rio
            function monitorarMudancas() {
                const btnGuardar = document.getElementById('btnGuardarTurno');

                document.querySelectorAll('#editarTurnoModal input').forEach((campo) => {
                    campo.addEventListener('input', () => {
                        const nomeAlterado = document.getElementById('editarNomeTurno').value !== turnoOriginal.nome;
                        const vagasTotaisAlteradas = document.getElementById('editarVagasTotais').value != turnoOriginal.vagasTotais;

                        // Habilitar bot√£o se qualquer campo for alterado
                        if (nomeAlterado || vagasTotaisAlteradas) {
                            btnGuardar.removeAttribute('disabled');
                        } else {
                            btnGuardar.setAttribute('disabled', 'disabled');
                        }
                    });
                });
            }

            // ‚úÖ Fun√ß√£o para validar Vagas Totais
            function validarVagasTotais() {
                const vagasTotaisInput = document.getElementById('editarVagasTotais');
                const vagasOcupadas = turnoOriginal.vagasOcupadas;

                vagasTotaisInput.addEventListener('input', () => {
                    const vagasTotais = parseInt(vagasTotaisInput.value);
                    if (isNaN(vagasTotais) || vagasTotais < vagasOcupadas) {
                        mostrarMensagem('Erro', 'O n√∫mero de vagas totais deve ser maior ou igual ao n√∫mero de vagas ocupadas.');
                        vagasTotaisInput.classList.add('is-invalid');
                    } else {
                        vagasTotaisInput.classList.remove('is-invalid');
                    }
                });
            }

            // ‚úÖ Fun√ß√£o para mostrar mensagens
            function mostrarMensagem(tipo, mensagem) {
                alert(`[${tipo}] ${mensagem}`);
            }

            // ‚úÖ Fun√ß√£o para enviar o formul√°rio de edi√ß√£o
            function enviarFormularioEditarTurno() {
                const turnoId = document.getElementById('editTurnoId').value;
                const nomeTurno = document.getElementById('editarNomeTurno').value;
                const vagasTotais = parseInt(document.getElementById('editarVagasTotais').value);

                // Valida√ß√£o de Vagas Totais
                const vagasOcupadas = parseInt(document.getElementById('editarVagasOcupadas').innerText);
                if (isNaN(vagasTotais) || vagasTotais < vagasOcupadas) {
                    alert('Erro: O n√∫mero de vagas totais deve ser maior ou igual ao n√∫mero de vagas ocupadas.');
                    return;
                }

                console.log('Enviando dados do turno:', {
                    turnoId,
                    nomeTurno,
                    vagasTotais
                });

                // Enviar os dados via AJAX
                fetch('/atualizar_turno/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        turno_id: turnoId,
                        nome_turno: nomeTurno,
                        vagas_totais: vagasTotais
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const modalBody = document.querySelector('#editarTurnoModal .modal-body');
                            modalBody.innerHTML = `
                <div class="text-center">
                    <h4 class="text-success">Turno atualizado com sucesso!</h4>
                    <img src="{% static 'images/certo.png' %}" alt="Sucesso" style="width: 100px; margin-top: 20px;">
                </div>
                `;
                            document.querySelector('#editarTurnoModal .modal-content').style.backgroundColor = '#d4edda';

                            document.querySelector('#btnGuardarTurno').style.display = 'none';
                            pesquisarDados(); // Atualizar a lista de turnos
                        } else {
                            alert('Erro ao atualizar turno: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar turno:', error);
                        alert('Erro ao atualizar turno. Tente novamente.');
                    });
            }

            // ‚úÖ Fun√ß√£o para obter o CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }


        </script>

        <script>
            function editarVagas(idTurno) {
                console.log('Abrindo modal para gerenciar alunos do turno:', idTurno);
                // Preencher o campo oculto com o ID do turno
                document.getElementById('editTurnoId').value = idTurno;

                fetch(`/obter_alunos_turno/${idTurno}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Dados do turno recebidos:', data);

                        const listaAlunos = document.getElementById('listaAlunosTurno');
                        listaAlunos.innerHTML = ''; // Limpar a lista atual

                        if (data.success && data.alunos.length > 0) {
                            data.alunos.forEach(aluno => {
                                const row = `
<tr>
    <td>
        <input type="checkbox" class="checkbox-aluno" data-id="${aluno.n_meca}" onchange="verificarSelecaoAlunos()">
    </td>
    <td>${aluno.n_meca}</td>
    <td>${aluno.p_nome} ${aluno.u_nome}</td>
</tr>
`;

                                listaAlunos.innerHTML += row;
                            });
                        } else {
                            listaAlunos.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">Nenhum aluno inscrito.</td>
                    </tr>
                `;
                        }

                        const editarVagasModal = new bootstrap.Modal(document.getElementById('editarVagasModal'));
                        editarVagasModal.show();
                    })
                    .catch(error => {
                        console.error('Erro ao obter os detalhes do turno:', error);
                        alert('Erro ao carregar as informa√ß√µes do turno. Tente novamente.');
                    });
            }

            // Fun√ß√£o para verificar se algum checkbox foi marcado
            function verificarSelecaoAlunos() {
                const checkboxes = document.querySelectorAll('.checkbox-aluno');
                const btnRemover = document.getElementById('btnRemoverAlunos');
                const algumSelecionado = Array.from(checkboxes).some(checkbox => checkbox.checked);

                btnRemover.disabled = !algumSelecionado;
            }

            // Fun√ß√£o para selecionar/deselecionar todos os checkboxes
            function selecionarTodosAlunos(masterCheckbox) {
                const checkboxes = document.querySelectorAll('.checkbox-aluno');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = masterCheckbox.checked;
                });
                verificarSelecaoAlunos();
            }

            function removerAlunosSelecionados() {
                const checkboxes = document.querySelectorAll('.checkbox-aluno:checked');
                const alunosSelecionados = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

                const turnoId = document.getElementById('editTurnoId')?.value;

                if (!turnoId) {
                    alert('Erro: ID do turno n√£o encontrado.');
                    return;
                }

                if (alunosSelecionados.length === 0) {
                    alert('Nenhum aluno selecionado para remo√ß√£o.');
                    return;
                }

                console.log('Alunos selecionados para remo√ß√£o:', alunosSelecionados);
                console.log('Turno ID:', turnoId);

                fetch('/remover_alunos_turno/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ alunos: alunosSelecionados, turno_id: turnoId })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Alunos removidos com sucesso!');

                            // ‚úÖ Fechar explicitamente o modal antes de recarregar
                            const editarVagasModal = bootstrap.Modal.getInstance(document.getElementById('editarVagasModal'));
                            if (editarVagasModal) {
                                editarVagasModal.hide();
                            }

                            // ‚úÖ Remover backdrop manualmente se necess√°rio
                            document.querySelector('.modal-backdrop')?.remove();

                            // ‚úÖ Recarregar os alunos no modal
                            setTimeout(() => {
                                editarVagas(turnoId);
                            }, 300); // Pequeno delay para evitar conflito
                        } else {
                            alert('Erro ao remover alunos: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao remover alunos:', error);
                        alert('Erro ao remover alunos. Tente novamente.');
                    });
            }
            document.addEventListener('hidden.bs.modal', function (event) {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                document.body.classList.remove('modal-open'); // Remove a classe modal-open
            });

            function adicionarAluno() {
                const turnoId = document.getElementById('editTurnoId').value;

                if (!turnoId) {
                    alert('Erro: ID do turno n√£o encontrado.');
                    return;
                }

                // Exibir um prompt para obter o n√∫mero mec√¢nico do aluno
                const n_meca = prompt('Digite o n√∫mero mec√¢nico do aluno:').trim();

                // Validar o n√∫mero mec√¢nico
                if (!n_meca || isNaN(n_meca)) {
                    alert('Por favor, insira um n√∫mero mec√¢nico v√°lido.');
                    return;
                }

                console.log('Adicionando aluno ao turno:', {
                    turno_id: turnoId,
                    n_meca,
                });

                // Enviar os dados para o backend
                fetch('/adicionar_aluno_turno/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // Inclua o token CSRF
                    },
                    body: JSON.stringify({
                        turno_id: turnoId,
                        aluno: {
                            n_meca,
                        }
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('‚úÖ Aluno adicionado com sucesso!');
                            // Recarregar a lista de alunos no modal
                            editarVagas(turnoId);
                        } else {
                            alert('‚ùå ERRO !:  ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('ERRO !:', error);
                        alert('‚ùå Erro ao adicionar aluno. Tente novamente.');
                    });
            }



            // Fun√ß√£o para obter o CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }


        </script>


        <script>
            let turnoParaExcluir = null;

            function eliminarTurno(idTurno) {
                console.log(`Preparando para excluir o turno com ID: ${idTurno}`);

                // Restaurar o modal ao seu estado original
                const modalBody = document.querySelector('#eliminarTurnoModal .modal-body');
                const modalFooter = document.querySelector('#eliminarTurnoModal .modal-footer');

                // Resetar conte√∫do do modal
                const modalContent = document.querySelector('#eliminarTurnoModal .modal-content');
                if (modalContent) {
                    modalContent.style.backgroundColor = '#FFFFFF'; // Cor branca padr√£o
                }

                modalBody.innerHTML = `
        <p>Tem certeza de que deseja excluir este turno?</p>
        <div id="detalhesTurno"></div>
    `;
                modalFooter.innerHTML = `
        <button type="button" class="btn btn-danger" onclick="confirmarExclusaoTurno()" disabled>
            <i class="bi bi-trash me-2"></i>Excluir
        </button>
    `;

                // Fazer uma requisi√ß√£o para verificar os detalhes do turno
                fetch(`/verificar_eliminar_turno/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": getCookie('csrftoken') // Se estiver usando Django com CSRF
                    },
                    body: new URLSearchParams({
                        turno_id: idTurno
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Dados do turno recebidos:', data);

                        if (data.success) {
                            turnoParaExcluir = idTurno;

                            // Mostrar mensagem no modal com base no retorno
                            const detalhesElemento = document.getElementById("detalhesTurno");
                            if (data.posso_eliminar) {
                                detalhesElemento.innerHTML = `
                        <span class="text-success">${data.mensagem}</span>
                    `;
                            } else {
                                detalhesElemento.innerHTML = `
                        <span class="text-danger">${data.mensagem}</span>
                    `;
                            }

                            // Gerenciar o estado do bot√£o de exclus√£o
                            const btnExcluir = document.querySelector("#eliminarTurnoModal .btn-danger");
                            if (data.posso_eliminar) {
                                btnExcluir.removeAttribute("disabled");
                            } else {
                                btnExcluir.setAttribute("disabled", "disabled");
                            }

                            // Mostrar o modal de confirma√ß√£o
                            const eliminarModal = new bootstrap.Modal(document.getElementById("eliminarTurnoModal"));
                            eliminarModal.show();
                        } else {
                            alert(data.error || "Erro ao verificar o turno.");
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter os detalhes do turno:', error);
                        alert('Erro ao carregar os detalhes do turno. Tente novamente.');
                    });
            }




            function confirmarExclusaoTurno() {
                if (!turnoParaExcluir) {
                    alert("Erro: Nenhum turno selecionado para exclus√£o.");
                    return;
                }
                fetch('/eliminar_turno/', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": getCookie('csrftoken') // Se estiver usando Django com CSRF
                    },
                    body: new URLSearchParams({
                        turno_id: turnoParaExcluir
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Alterar o conte√∫do do modal para mostrar mensagem de sucesso
                            const modalBody = document.querySelector('#eliminarTurnoModal .modal-body');
                            modalBody.innerHTML = `
                    <div class="text-center">
                        <h4 class="text-success">Turno eliminado com sucesso!</h4>
                       <img src="{% static 'images/certo.png' %}" alt="Sucesso" style="width: 100px; margin-top: 20px;">
                    </div>
                `;
                            // Alterar o fundo do modal (opcional)
                            const modalContent = document.querySelector('#eliminarTurnoModal .modal-content');
                            modalContent.style.backgroundColor = '#d4edda';
                            // Desativar os bot√µes no modal (opcional)
                            const btnExcluir = document.querySelector('#eliminarTurnoModal .btn-danger');
                            if (btnExcluir) {
                                btnExcluir.style.display = 'none'; // Esconder o bot√£o
                            }


                            // Atualizar a lista imediatamente
                            pesquisarDados(); // Atualizar a lista
                        } else {
                            alert("Erro ao eliminar turno: " + data.error);
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao eliminar turno:", error);
                        alert("Erro ao eliminar turno. Tente novamente.");
                    });
            }


        </script>

        <script>

            function carregarTurnosSemHorarios() {
                fetch('/obter_turnos_sem_horarios/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const selectTurno = document.getElementById("idTurno");
                            selectTurno.innerHTML = ""; // Limpar op√ß√µes anteriores
                            const defaultOption = document.createElement("option");
                            defaultOption.value = "";
                            defaultOption.textContent = "Selecione o turno...";
                            selectTurno.appendChild(defaultOption);

                            data.turnos.forEach(turno => {
                                const option = document.createElement("option");
                                option.value = turno.id_turno;
                                option.textContent = `${turno.turno_nome} (UC: ${turno.id_uc}, Semestre: ${turno.id_semestre})`;
                                selectTurno.appendChild(option);
                            });
                        } else {
                            alert("Erro ao carregar turnos: " + data.error);
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar turnos sem hor√°rios:", error);
                    });
            }

            function atualizarEspacosDisponiveis() {
                const diaSemana = document.getElementById("diaSemana").value;
                const horaInicio = document.getElementById("horaInicio").value;
                const horaFim = document.getElementById("horaFim").value;

                if (!diaSemana || !horaInicio || !horaFim) {
                    // Caso algum campo esteja vazio, n√£o fa√ßa nada
                    return;
                }

                // Enviar os dados para o backend para buscar os espa√ßos dispon√≠veis
                fetch('/espacos_disponiveis/', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": getCookie('csrftoken') // Inclua o token CSRF, se necess√°rio
                    },
                    body: new URLSearchParams({
                        dia_semana: diaSemana,
                        hora_inicio: horaInicio,
                        hora_fim: horaFim
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        const selectEspaco = document.getElementById("idEspaco");
                        selectEspaco.innerHTML = ""; // Limpar as op√ß√µes anteriores

                        if (data.success) {
                            // Adicionar op√ß√£o padr√£o
                            const defaultOption = document.createElement("option");
                            defaultOption.value = "";
                            defaultOption.textContent = "Selecione o espa√ßo...";
                            defaultOption.disabled = true;
                            defaultOption.selected = true;
                            selectEspaco.appendChild(defaultOption);

                            // Preencher o select com os espa√ßos dispon√≠veis
                            data.espacos.forEach(espaco => {
                                const option = document.createElement("option");
                                option.value = espaco.id_espaco;
                                option.textContent = `Sala ${espaco.numero_sala}`;
                                selectEspaco.appendChild(option);
                            });
                        } else {
                            alert("Erro ao carregar espa√ßos dispon√≠veis: " + data.error);
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar espa√ßos dispon√≠veis:", error);
                    });
            }

            // Adicionar eventos aos campos relevantes
            document.getElementById("diaSemana").addEventListener("change", atualizarEspacosDisponiveis);
            document.getElementById("horaInicio").addEventListener("change", atualizarEspacosDisponiveis);
            document.getElementById("horaFim").addEventListener("change", atualizarEspacosDisponiveis);


            function adicionarHorario() {
                // Obter os valores do formul√°rio
                const turnoId = document.getElementById("idTurno").value;
                const diaSemana = document.getElementById("diaSemana").value;
                const horaInicio = document.getElementById("horaInicio").value;
                const horaFim = document.getElementById("horaFim").value;
                const espacoId = document.getElementById("idEspaco").value;

                // Verificar se todos os campos est√£o preenchidos
                if (!turnoId || !diaSemana || !horaInicio || !horaFim || !espacoId) {
                    alert("Por favor, preencha todos os campos antes de salvar.");
                    return;
                }

                // Enviar os dados para o backend
                fetch("/adicionar_horario/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken") // Incluir token CSRF para seguran√ßa
                    },
                    body: JSON.stringify({
                        turno_id: turnoId,
                        dia_semana: diaSemana,
                        hora_inicio: horaInicio,
                        hora_fim: horaFim,
                        espaco_id: espacoId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Hor√°rio salvo com sucesso!");
                            // Fechar o modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById("criarHorarioModal"));
                            modal.hide();

                        } else {
                            alert("Erro ao salvar hor√°rio: " + data.error);
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao salvar hor√°rio:", error);
                        alert("Erro ao salvar hor√°rio. Tente novamente.");
                    });
            }

            // Fun√ß√£o para carregar os cursos na pesquisa
            function carregarCursosPesquisa_horairos() {
                fetch('/obter_cursos/')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro na requisi√ß√£o: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Resposta do backend:', data)
                        if (data.error) {
                            console.error('Erro no backend:', data.error);
                            return;
                        }

                        const selectCursoPesquisa = document.getElementById('cursoPesquisa_horarios');
                        selectCursoPesquisa.innerHTML = '<option selected disabled>Escolha o curso...</option>'; // Limpa op√ß√µes antigas

                        // Verifica se h√° dados e popula o seletor
                        if (Array.isArray(data) && data.length > 0) {
                            data.forEach(curso => {
                                const option = document.createElement('option');
                                option.value = curso.id_curso;
                                option.textContent = curso.nome_curso;
                                selectCursoPesquisa.appendChild(option);
                            });
                            console.log('Cursos carregados com sucesso.');
                        } else {
                            console.warn('Nenhum curso encontrado.');
                        }
                    })
                    .catch(error => console.error('Erro ao carregar cursos para pesquisa:', error));
            }

            document.getElementById('horarios-tab').addEventListener('shown.bs.tab', () => {
                console.log('Aba "Hor√°rios" clicada, carregando cursos...');
                carregarCursosPesquisa_horairos();
            });
            // Fun√ß√£o para carregar os anos da base de dados
            function carregarAnos_horarios() {
                fetch('/obter_anos/')
                    .then(response => response.json())
                    .then(data => {
                        const selectAno = document.getElementById('ano_horario');
                        selectAno.innerHTML = '<option selected disabled>Escolha o ano...</option>';
                        data.forEach(ano => {
                            const option = document.createElement('option');
                            option.value = ano.id_ano; // Use o campo correto da sua fun√ß√£o SQL
                            option.textContent = ano.nome_ano; // Exemplo: '1¬∫ Ano'
                            selectAno.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro ao carregar anos:', error));
            }

            // Fun√ß√£o para carregar os semestres da base de dados
            function carregarSemestres_horarios() {
                fetch('/obter_semestres/')
                    .then(response => response.json())
                    .then(data => {
                        const selectSemestre = document.getElementById('semestre_horario');
                        selectSemestre.innerHTML = '<option selected disabled>Escolha o semestre...</option>';
                        data.forEach(semestre => {
                            const option = document.createElement('option');
                            option.value = semestre.id_semestre; // Use o campo correto da sua fun√ß√£o SQL
                            option.textContent = semestre.nome_semestre; // Exemplo: '1¬∫ Semestre'
                            selectSemestre.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro ao carregar semestres:', error));
            }

            function carregarTurnos_horarios() {
                fetch('/obter_turnos/')
                    .then(response => response.json())
                    .then(data => {
                        const selectTurno = document.getElementById('turno_horario');
                        selectTurno.innerHTML = '<option selected disabled>Escolha o turno...</option>';
                        if (data.success) {
                            data.turnos.forEach(turno => {
                                const option = document.createElement('option');
                                option.value = turno;
                                option.textContent = turno;
                                selectTurno.appendChild(option);
                            });
                        } else {
                            console.error('Erro ao carregar turnos:', data.error);
                        }
                    })
                    .catch(error => console.error('Erro ao carregar turnos:', error));
            }

            // Chamando as fun√ß√µes ao carregar a p√°gina
            document.addEventListener('DOMContentLoaded', () => {
                carregarAnos_horarios();
                carregarSemestres_horarios();
                carregarTurnos_horarios();
            });

            function pesquisarHorarios() {
                const cursoId = document.getElementById("cursoPesquisa_horarios").value;
                const ano = document.getElementById("ano_horario").value;
                const semestre = document.getElementById("semestre_horario").value;
                const turno = document.getElementById("turno_horario").value;

                if (!cursoId || !ano || !semestre || !turno) {
                    alert("Por favor, preencha todos os campos para realizar a pesquisa.");
                    return;
                }

                // Exibir um spinner de carregamento enquanto a pesquisa √© feita
                const loadingSpinner = document.getElementById("loadingSpinner");
                loadingSpinner.style.display = "block";

                fetch(`/pesquisar_horarios_filtrados/?curso_id=${cursoId}&ano=${ano}&semestre=${semestre}&turno=${turno}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingSpinner.style.display = "none"; // Esconde o spinner

                        if (data.success) {
                            atualizarTabelaHorarios(data.data); // Preenche a tabela com os dados
                        } else {
                            alert(data.error || "Erro ao buscar hor√°rios.");
                        }
                    })
                    .catch(error => {
                        loadingSpinner.style.display = "none"; // Esconde o spinner
                        console.error("Erro ao buscar hor√°rios:", error);
                    });
            }
            function formatarHora(hora) {
                // Divide a hora no formato HH:mm:ss e retorna apenas HH:mm
                return hora.split(":").slice(0, 2).join(":");
            }

            function atualizarTabelaHorarios(horarios) {
                const tabelaResultados = document.getElementById("resultadosDisponiveis_horarios");
                tabelaResultados.innerHTML = ""; // Limpa a tabela antes de preencher com novos resultados

                // Atualiza o contador de resultados
                document.getElementById("quantidadeResultados_horarios").textContent = horarios.length;

                if (horarios.length === 0) {
                    tabelaResultados.innerHTML = "<tr><td colspan='5'>Nenhum hor√°rio encontrado.</td></tr>";
                    return;
                }

                // Preenche a tabela com os resultados retornados
                horarios.forEach(horario => {
                    const row = `
            <tr>
                <td>${horario.turno_nome}</td>
                <td>${horario.nome_uc}</td>
                <td>${horario.dia_semana}</td>
                <td>${formatarHora(horario.hora_inicio)}</td>
                <td>${formatarHora(horario.hora_fim)}</td>
                <td>
            <td>
            <button 
                class="btn btn-warning btn-sm"
                onclick="editarHorario(${horario.id_horario})"  
                data-id-ano="${horario.id_ano}"
                data-id-semestre="${horario.id_semestre}"
                data-id-curso="${horario.id_curso}"
                data-turno-nome="${horario.turno_nome}"
            >
                <i class="bi bi-pencil"></i> Editar
            </button>
        
           <button type="button" class="btn btn-danger" 
        data-bs-toggle="modal" 
        data-bs-target="#removerHorarioModal" 
        onclick="setHorarioParaRemover(${horario.id_horario})">
  <i class="bi bi-trash"></i> Eliminar Hor√°rio

        </td>
            </tr>`;
                    tabelaResultados.innerHTML += row;
                });
            }


        </script>
        <script type="text/javascript">
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Verifica se este cookie come√ßa com o nome desejado
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const botaoSalvar = document.getElementById("botaoSalvar");
                const diaSemana = document.getElementById("editarDiaSemana");
                const horaInicio = document.getElementById("editarHoraInicio");
                const horaFim = document.getElementById("editarHoraFim");

                // Valores iniciais para compara√ß√£o
                let valoresOriginais = {
                    diaSemana: "",
                    horaInicio: "",
                    horaFim: ""
                };

                // Fun√ß√£o para verificar se os valores foram alterados
                function verificarAlteracoes() {
                    const alterado =
                        diaSemana.value !== valoresOriginais.diaSemana ||
                        horaInicio.value !== valoresOriginais.horaInicio ||
                        horaFim.value !== valoresOriginais.horaFim;

                    botaoSalvar.disabled = !alterado; // Ativa o bot√£o se algo foi alterado
                }

                // Fun√ß√£o para preencher valores iniciais ao abrir o modal
                function preencherValoresOriginais(dia, inicio, fim) {
                    valoresOriginais = { diaSemana: dia, horaInicio: inicio, horaFim: fim };
                    diaSemana.value = dia;
                    horaInicio.value = inicio;
                    horaFim.value = fim;

                    verificarAlteracoes(); // Verificar altera√ß√µes logo ap√≥s o preenchimento
                }

                // Adiciona os eventos para verificar altera√ß√µes
                diaSemana.addEventListener("input", verificarAlteracoes);
                horaInicio.addEventListener("input", verificarAlteracoes);
                horaFim.addEventListener("input", verificarAlteracoes);

                // Exemplo: Chamada para preencher valores originais ao abrir o modal
                window.abrirModalEditar = function (dados) {
                    preencherValoresOriginais(dados.diaSemana, dados.horaInicio, dados.horaFim);
                    const modal = new bootstrap.Modal(document.getElementById("editarHorarioModal"));
                    modal.show();
                };
            });

            function editarHorario(idHorario) {
                document.getElementById('editarHorarioId').value = idHorario;
                // Obter os valores selecionados
                const cursoSelecionado = document.getElementById('cursoPesquisa_horarios').value;
                const anoSelecionado = document.getElementById('ano_horario').value;
                const semestreSelecionado = document.getElementById('semestre_horario').value;
                const turnoSelecionado = document.getElementById('turno_horario').value;

                // Verificar se todos os campos foram preenchidos
                if (!cursoSelecionado || !anoSelecionado || !semestreSelecionado || !turnoSelecionado) {
                    alert('Por favor, selecione todas as op√ß√µes antes de editar o hor√°rio.');
                    return;
                }

                // Fazer uma requisi√ß√£o para buscar os detalhes do hor√°rio
                fetch(`/obter_horario/${idHorario}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Preencher o modal com os dados do hor√°rio
                            document.getElementById('editarDiaSemana').value = data.horario.dia_semana;
                            document.getElementById('editarHoraInicio').value = data.horario.hora_inicio;
                            document.getElementById('editarHoraFim').value = data.horario.hora_fim;

                            // Exibir o modal
                            const editarHorarioModal = new bootstrap.Modal(document.getElementById('editarHorarioModal'));
                            editarHorarioModal.show();
                        } else {
                            alert('Erro ao obter os dados do hor√°rio.');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter o hor√°rio:', error);
                        alert('Erro ao carregar os dados do hor√°rio.');
                    });

                // Exibir os valores no console para depura√ß√£o
                console.log('Valores selecionados:');
                console.log('Curso:', cursoSelecionado);
                console.log('Ano:', anoSelecionado);
                console.log('Semestre:', semestreSelecionado);
                console.log('Turno:', turnoSelecionado);
            }




            function salvarEdicaoHorario() {
                const diaaSemana = document.getElementById('editarDiaSemana')?.value;
                if (!diaaSemana) {
                    alert("Erro: Dia da semana n√£o est√° definido.");
                    return;
                }
                const horaInicio = document.getElementById('editarHoraInicio').value;
                const horaFim = document.getElementById('editarHoraFim').value;
                const horarioId = document.getElementById('editarHorarioId').value;

                if (!horarioId) {
                    alert("Erro: ID do hor√°rio n√£o encontrado.");
                    return;
                }

                // Obter os valores selecionados nos selects
                const cursoSelecionado = document.getElementById('cursoPesquisa_horarios').value;
                const anoSelecionado = document.getElementById('ano_horario').value;
                const semestreSelecionado = document.getElementById('semestre_horario').value;
                const turnoSelecionado = document.getElementById('turno_horario').value;

                // Verificar se todos os campos est√£o preenchidos
                if (!diaaSemana || !horaInicio || !horaFim || !cursoSelecionado || !anoSelecionado || !semestreSelecionado || !turnoSelecionado) {
                    alert("Por favor, preencha todos os campos antes de salvar.");
                    return;
                }

                // Exibir os dados enviados no console para depura√ß√£o
                console.log("Dados enviados para edi√ß√£o:", {
                    dia_semana: diaaSemana,
                    hora_inicio: horaInicio,
                    hora_fim: horaFim,
                    id_curso: cursoSelecionado,
                    id_ano: anoSelecionado,
                    id_semestre: semestreSelecionado,
                    turno_nome: turnoSelecionado,
                });

                // Enviar diretamente para salvar as altera√ß√µes
                fetch(`/editar_horario/${horarioId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        dia_semana: diaaSemana,
                        hora_inicio: horaInicio,
                        hora_fim: horaFim,
                        id_curso: cursoSelecionado,
                        id_ano: anoSelecionado,
                        id_semestre: semestreSelecionado,
                        turno_nome: turnoSelecionado,
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Hor√°rio atualizado com sucesso!");
                            // Atualiza a tabela ap√≥s salvar as altera√ß√µes
                            pesquisarHorarios();
                            // Fecha o modal
                            const editarHorarioModal = bootstrap.Modal.getInstance(document.getElementById('editarHorarioModal'));
                            editarHorarioModal.hide();
                        } else {
                            alert(data.error || "Erro ao atualizar o hor√°rio.");
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao salvar as altera√ß√µes:", error);
                        alert("Erro ao salvar as altera√ß√µes do hor√°rio.");
                    });
            }








        </script>

        <script>
            let horarioIdParaRemover = null;

            function setHorarioParaRemover(idHorario) {
                // Armazena o ID do hor√°rio selecionado
                horarioIdParaRemover = idHorario;

                // Opcional: Exibe o ID no modal para confirma√ß√£o
                const modalBody = document.querySelector('#removerHorarioModal .modal-body');
                modalBody.textContent = `Tem a certeza que quer eliminar este horario?`;
            }

            // Remove o hor√°rio quando o bot√£o de confirma√ß√£o √© clicado
            document.getElementById('confirmarRemocaoBtn').addEventListener('click', function () {
                if (!horarioIdParaRemover) {
                    alert("Erro: Nenhum hor√°rio selecionado para remo√ß√£o.");
                    return;
                }

                // Faz a requisi√ß√£o DELETE para remover o hor√°rio
                fetch(`/remover_horario/${horarioIdParaRemover}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken, // Certifique-se de incluir o CSRF Token se necess√°rio
                    },
                })
                    .then(response => {
                        if (response.ok) {
                            alert("Hor√°rio removido com sucesso!");
                            const removerHorarioModal = bootstrap.Modal.getInstance(document.getElementById('removerHorarioModal'));
                            removerHorarioModal.hide();
                            pesquisarHorarios();
                        } else {
                            response.json().then(data => {
                                alert(data.error || "Erro ao remover o hor√°rio.");
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao remover o hor√°rio:", error);
                        alert("Erro ao remover o hor√°rio.");
                    });
            });
        </script>